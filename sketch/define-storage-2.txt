# Databases for my application 1

storage_set myapp1

db_set user
  .desc = User database
  .name.template = user

table_set user.user
  .desc = User main data
  .name.template = user
table_set user.user_option
  .desc = User additional data
  .name.template = user_option

table_suffix_type timeline_type

table_suffix timeline_type.activities
  .index = 12
  .timeline_type_id = 2
table_suffix timeline_type.guestbook
  .index = 13
  .timeline_type_id = 3
table_suffix timeline_type.feed
  .index = 14
  .timeline_type_id = 4

db_set timeline[timeline_type][]
  .name.template = timeline_{$1.index}_{$2}
db_set timeline_delivery[timeline_type][]
  .name.template = timeline_delivery_{$1.index}_{$2}

table_set timeline.index[timeline_type][]
  .name.template = tlindex_{$1.index}_{$2}
table_set timeline.index_option[timeline_type][]
  .name.template = tlindex_option_{$1.index}_{$2}
table_set timeline_delivery.index_delivery[timeline_type][]
  .name.template = tlindex_delivery_{$1.index}_{$2}
  .table_stem.template = tlindex_delivery
  .timeline_type.template = {$1.timeline_type_id}

storage_role myapp1-userdb
  .desc = User DB
  .hostname.master = 192.168.0.1
  .hostname.default = 192.168.0.2
  .hostname.batch = 192.168.0.3
storage_role myapp1-timelinedb1
  .desc = Timeline DB, region 1
storage_role myapp1-timelinedb2
  .desc = Timeline DB, region 2
storage_role myapp1-queuedb

app_role backend1
  .desc = Default application servers, region 1
app_role backend2
  .desc = Default application servers, region 2
app_role checker
  .desc = Read-only storage checker

db myapp1-userdb.user
  .datasource.backend1 <- default,batch
  .datasource.backend2 <- default,batch

table user.user
table user.user_option

db myapp1-timelinedb1.timeline[activities][1]
  .datasource.backend1 <- master,default,batch
  .datasource.backend2 <-        default,batch
  .datasource.checker  <-                batch
db myapp1-timelinedb1.timeline[guestbook][1]
  .datasource.backend1 <- master,default,batch
  .datasource.backend2 <-        default,batch
  .datasource.checker  <-                batch

db myapp1-timelinedb2.timeline[activities][2]
  .datasource.backend1 <-        default,batch
  .datasource.backend2 <- master,default,batch
  .datasource.checker  <-                batch

db myapp1-queuedb.timeline_delivery[activities][1]

table timeline[activities][1].index[activities][1]
table timeline[activities][1].index_option[activities][1]
table timeline[guestbook][1].index[guestbook][1]
table timeline[guestbook][1].index_option[guestbook][1]
table timeline[activities][2].index[activities][2]
table timeline[activities][2].index_option[activities][2]

table timeline_delivery[activities][1].index_delivery[activities][1]
table timeline_delivery[activities][1].index_delivery[activities][2]
